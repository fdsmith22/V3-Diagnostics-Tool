{% extends "base.html" %}

{% block title %}V3 Diagnostics Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<link href="{{ url_for('static', filename='css/dashboard-enhanced.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header with just refresh button -->
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-refresh" id="refresh-status">
            <i class="material-icons align-middle">refresh</i>
            <span class="d-none d-sm-inline ms-1">Refresh</span>
        </button>
    </div>

    <!-- Compact Status Cards Row -->
    <div class="row g-3 mb-4">
        <!-- Connection Status -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="status-card-compact">
                <div class="status-card-icon">
                    <i class="material-icons">wifi</i>
                </div>
                <div class="status-card-content">
                    <div class="status-card-title">Connection</div>
                    <div class="connection-indicator disconnected" id="connection-status">
                        <span class="pulse"></span>
                        <span class="status-text">Disconnected</span>
                    </div>
                    <div class="status-card-subtitle" id="connection-message">No device connected</div>
                </div>
            </div>
        </div>

        <!-- Battery Status -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="status-card-compact">
                <div class="status-card-icon">
                    <i class="material-icons">battery_charging_full</i>
                </div>
                <div class="status-card-content">
                    <div class="status-card-title">Battery</div>
                    <div class="battery-display">
                        <div class="battery-visual">
                            <div class="battery-fill low" id="battery-fill" style="width: 0%"></div>
                        </div>
                        <span class="battery-percent" id="battery-percent">0%</span>
                    </div>
                    <div class="status-card-subtitle" id="battery-status">No battery</div>
                </div>
            </div>
        </div>

        <!-- Temperature -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="status-card-compact">
                <div class="status-card-icon">
                    <i class="material-icons">thermostat</i>
                </div>
                <div class="status-card-content">
                    <div class="status-card-title">Temperature</div>
                    <div class="temp-display">
                        <span class="temp-value" id="temp-value">--</span>
                        <span class="temp-unit">Â°C</span>
                        <span class="temp-status normal" id="temp-status">Normal</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network/Uptime -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="status-card-compact">
                <div class="status-card-icon">
                    <i class="material-icons">access_time</i>
                </div>
                <div class="status-card-content">
                    <div class="status-card-title">Uptime</div>
                    <div class="uptime-display">
                        <span class="uptime-value" id="uptime-value">--</span>
                        <span class="status-card-subtitle" id="last-update">Last updated: --</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information Card - Horizontal Layout -->
    <div class="system-info-card card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="material-icons align-middle me-2">info</i>
                System Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- First Column -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="d-flex flex-column">
                        <small class="text-muted mb-1">Device ID</small>
                        <span class="fw-semibold" id="device-id">--</span>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="d-flex flex-column">
                        <small class="text-muted mb-1">Firmware Version</small>
                        <span class="fw-semibold" id="firmware-version">--</span>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="d-flex flex-column">
                        <small class="text-muted mb-1">IP Address</small>
                        <span class="fw-semibold" id="ip-address-table">--</span>
                    </div>
                </div>
                <!-- Second Row -->
                <div class="col-12 col-md-6 col-lg-8">
                    <div class="d-flex flex-column">
                        <small class="text-muted mb-1">Processor</small>
                        <span class="fw-semibold" id="processor">--</span>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="d-flex flex-column">
                        <small class="text-muted mb-1">Network Interface</small>
                        <span class="fw-semibold" id="network-interface">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostic Test Log Container -->
    <div class="diagnostic-log-card card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="material-icons align-middle me-2">assignment</i>
                Diagnostic Test Results
            </h5>
        </div>
        <div class="card-body">
            <div id="diagnostic-results" class="diagnostic-results-container">
                <div class="text-center text-muted py-4">
                    <i class="material-icons mb-2" style="font-size: 48px; opacity: 0.3;">science</i>
                    <p>Click "Run Tests" to start diagnostic checks</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Dashboard update functionality
(function() {
    let updateTimer = null;
    const UPDATE_INTERVAL = 15000; // 15 seconds

    function updateDashboard() {
        fetch('/api/system/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.data) {
                    updateStatusCards(data.data);
                }
            })
            .catch(error => {
                console.error('Failed to update dashboard:', error);
            });
    }

    function updateStatusCards(data) {
        // Connection Status
        const connectionIndicator = document.getElementById('connection-status');
        const connectionMessage = document.getElementById('connection-message');
        if (data.connected) {
            connectionIndicator.classList.remove('disconnected');
            connectionIndicator.classList.add('connected');
            connectionIndicator.querySelector('.status-text').textContent = 'Connected';
            connectionMessage.textContent = data.deviceId || 'Device connected';
        } else {
            connectionIndicator.classList.remove('connected');
            connectionIndicator.classList.add('disconnected');
            connectionIndicator.querySelector('.status-text').textContent = 'Disconnected';
            connectionMessage.textContent = data.connectionMessage || 'No device connected';
        }

        // Battery Status
        const batteryLevel = data.batteryLevel || 0;
        const batteryFill = document.getElementById('battery-fill');
        const batteryPercent = document.getElementById('battery-percent');
        const batteryStatus = document.getElementById('battery-status');
        
        batteryPercent.textContent = batteryLevel + '%';
        batteryFill.style.width = batteryLevel + '%';
        
        // Update battery color based on level
        batteryFill.classList.remove('low', 'medium', 'high');
        if (batteryLevel <= 20) {
            batteryFill.classList.add('low');
            batteryStatus.textContent = 'Low battery';
        } else if (batteryLevel <= 60) {
            batteryFill.classList.add('medium');
            batteryStatus.textContent = 'Battery OK';
        } else {
            batteryFill.classList.add('high');
            batteryStatus.textContent = 'Battery good';
        }
        
        if (batteryLevel === 0) {
            batteryStatus.textContent = 'No battery detected';
        }

        // Temperature
        const tempValue = document.getElementById('temp-value');
        const tempStatus = document.getElementById('temp-status');
        const temp = parseFloat(data.temperature) || 0;
        
        tempValue.textContent = temp ? temp.toFixed(1) : '--';
        
        tempStatus.classList.remove('normal', 'warm', 'hot');
        if (temp < 50) {
            tempStatus.classList.add('normal');
            tempStatus.textContent = 'Normal';
        } else if (temp < 70) {
            tempStatus.classList.add('warm');
            tempStatus.textContent = 'Warm';
        } else {
            tempStatus.classList.add('hot');
            tempStatus.textContent = 'Hot';
        }

        // Uptime & Last Update
        document.getElementById('uptime-value').textContent = data.uptime || '--';
        document.getElementById('last-update').textContent = data.lastUpdate ? `Last updated: ${data.lastUpdate}` : 'Last updated: --';

        // System Information Table
        document.getElementById('device-id').textContent = data.deviceId || '--';
        document.getElementById('firmware-version').textContent = data.firmwareVersion || '--';
        document.getElementById('processor').textContent = data.processor || '--';
        document.getElementById('ip-address-table').textContent = data.ipAddress || '--';
        // Only show network interface if device is actually connected
        if (data.connected) {
            document.getElementById('network-interface').textContent = data.ipAddress && data.ipAddress !== '--' ? 'WiFi Connected' : 'Not Connected';
        } else {
            document.getElementById('network-interface').textContent = '--';
        }
    }

    // Refresh button
    const refreshBtn = document.getElementById('refresh-status');
    refreshBtn.addEventListener('click', function() {
        this.classList.add('spinning');
        updateDashboard();
        setTimeout(() => {
            this.classList.remove('spinning');
        }, 1000);
    });

    // Initial load
    updateDashboard();

    // Set up auto-refresh
    updateTimer = setInterval(updateDashboard, UPDATE_INTERVAL);

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (updateTimer) {
            clearInterval(updateTimer);
        }
    });

    // Diagnostic Test Results Display (updated by WebSocket from sidebar button)
    window.updateDiagnosticResults = function(results) {
        const diagnosticResults = document.getElementById('diagnostic-results');
        
        if (results) {
            let resultsHTML = '<div class="diagnostic-test-list accordion" id="diagnosticAccordion">';
            let testIndex = 0;
            
            for (const [test, result] of Object.entries(results)) {
                const statusClass = result.status === 'passed' ? 'success' : 
                                   result.status === 'warning' ? 'warning' : 'danger';
                const statusIcon = result.status === 'passed' ? 'check_circle' : 
                                  result.status === 'warning' ? 'warning' : 'error';
                const testId = `test-${testIndex}`;
                const collapseId = `collapse-${testIndex}`;
                
                resultsHTML += `
                    <div class="diagnostic-test-item accordion-item">
                        <div class="diagnostic-test-header accordion-header" id="${testId}">
                            <button class="diagnostic-test-button accordion-button collapsed" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#${collapseId}" 
                                    aria-expanded="false" 
                                    aria-controls="${collapseId}">
                                <div class="d-flex justify-content-between align-items-center w-100 pe-4">
                                    <div class="d-flex align-items-center">
                                        <i class="material-icons text-${statusClass} me-2">${statusIcon}</i>
                                        <div>
                                            <strong>${test.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>
                                            <div class="small text-muted">${result.message || ''}</div>
                                        </div>
                                    </div>
                                    <span class="badge bg-${statusClass}">${result.status}</span>
                                </div>
                            </button>
                        </div>
                        <div id="${collapseId}" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="${testId}" 
                             data-bs-parent="#diagnosticAccordion">
                            <div class="diagnostic-test-body accordion-body">
                                <pre class="diagnostic-output-pre"><code>${result.output || 'No output available'}</code></pre>
                            </div>
                        </div>
                    </div>
                `;
                testIndex++;
            }
            
            resultsHTML += '</div>';
            resultsHTML += `<div class="text-muted small mt-3">Tests completed at ${new Date().toLocaleTimeString()}</div>`;
            
            diagnosticResults.innerHTML = resultsHTML;
        }
    };
    
    // Show loading state when diagnostics are running
    window.showDiagnosticLoading = function() {
        const diagnosticResults = document.getElementById('diagnostic-results');
        diagnosticResults.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Running diagnostics...</span>
                </div>
                <p class="mt-2 text-muted">Running diagnostic tests...</p>
            </div>
        `;
    };
})();
</script>
{% endblock %}